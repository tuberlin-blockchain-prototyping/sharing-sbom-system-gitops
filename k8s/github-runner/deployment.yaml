apiVersion: apps/v1
kind: Deployment
metadata:
  name: github-runner
  namespace: github-runner
spec:
  replicas: 2
  selector:
    matchLabels:
      app: github-runner
  template:
    metadata:
      labels:
        app: github-runner
    spec:
      serviceAccountName: github-runner
      initContainers:
        - name: runner-register
          image: alpine:latest
          command: ["/bin/sh"]
          args:
            - -c
            - |
              apk add --no-cache jq curl openssl

              generate_jwt() {
                local app_id="$1"
                local private_key="$2"
                local now=$(date +%s)
                local exp=$((now + 600))
                
                local temp_key_file=$(mktemp)
                echo "$private_key" > "$temp_key_file"
                
                local header=$(echo -n '{"alg":"RS256","typ":"JWT"}' | base64 | tr -d '=' | tr '/+' '_-' | tr -d '\n')
                local payload=$(echo -n "{\"iat\":${now},\"exp\":${exp},\"iss\":${app_id}}" | base64 | tr -d '=' | tr '/+' '_-' | tr -d '\n')
                local signature=$(echo -n "${header}.${payload}" | openssl dgst -sha256 -sign "$temp_key_file" -binary | base64 | tr -d '=' | tr '/+' '_-' | tr -d '\n')
                
                rm -f "$temp_key_file"
                echo "${header}.${payload}.${signature}"
              }

              get_installation_token() {
                local jwt="$1"
                local org="$2"
                
                local installations_response=$(curl -s -X GET \
                  -H "Authorization: Bearer ${jwt}" \
                  -H "Accept: application/vnd.github.v3+json" \
                  "https://api.github.com/orgs/${org}/installations")
                
                local installation_id=$(echo "$installations_response" | jq -r '.[0].id // empty')
                
                if [ -z "$installation_id" ] || [ "$installation_id" == "null" ]; then
                  echo "ERROR: Could not find installation ID for organization ${org}" >&2
                  exit 1
                fi
                
                local token_response=$(curl -s -X POST \
                  -H "Authorization: Bearer ${jwt}" \
                  -H "Accept: application/vnd.github.v3+json" \
                  "https://api.github.com/app/installations/${installation_id}/access_tokens")
                
                echo "$token_response" | jq -r '.token // empty'
              }

              echo "Generating GitHub App JWT token..."
              JWT=$(generate_jwt "$ABP_ACTIONS_RUNNER_APP_ID" "$ABP_ACTIONS_RUNNER_APP_PRIVATE_KEY")

              if [ -z "$JWT" ]; then
                echo "ERROR: Failed to generate JWT token"
                exit 1
              fi

              echo "Getting installation access token..."
              INSTALLATION_TOKEN=$(get_installation_token "$JWT" "$ORG_NAME")

              if [ -z "$INSTALLATION_TOKEN" ] || [ "$INSTALLATION_TOKEN" == "null" ]; then
                echo "ERROR: Failed to get installation access token"
                exit 1
              fi

              echo "Fetching organization-level registration token..."
              RESPONSE=$(curl -sX POST \
                -H "Authorization: token ${INSTALLATION_TOKEN}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/orgs/${ORG_NAME}/actions/runners/registration-token")

              TOKEN=$(echo "$RESPONSE" | jq -r '.token // empty')

              if [ -z "$TOKEN" ] || [ "$TOKEN" == "null" ]; then
                echo "ERROR: Failed to extract registration token"
                echo "Response: $RESPONSE"
                exit 1
              fi

              echo -n "$TOKEN" > /runner-token/token
              echo "Registration token saved"
          env:
            - name: ABP_ACTIONS_RUNNER_APP_ID
              valueFrom:
                secretKeyRef:
                  name: github-runner-secret
                  key: ABP_ACTIONS_RUNNER_APP_ID
            - name: ABP_ACTIONS_RUNNER_APP_PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  name: github-runner-secret
                  key: ABP_ACTIONS_RUNNER_APP_PRIVATE_KEY
            - name: ORG_NAME
              valueFrom:
                secretKeyRef:
                  name: github-runner-secret
                  key: ORG_NAME
          volumeMounts:
            - name: runner-token
              mountPath: /runner-token
      containers:
        - name: runner
          image: ghcr.io/actions/actions-runner:latest
          env:
            - name: RUNNER_NAME
              valueFrom:
                configMapKeyRef:
                  name: github-runner-config
                  key: RUNNER_NAME
            - name: RUNNER_LABELS
              valueFrom:
                configMapKeyRef:
                  name: github-runner-config
                  key: RUNNER_LABELS
          command: ["/bin/sh"]
          args:
            - -c
            - |
              TOKEN=$(cat /runner-token/token)
              ./config.sh --url https://github.com/tuberlin-blockchain-prototyping \
                --token $TOKEN \
                --name $RUNNER_NAME \
                --labels $RUNNER_LABELS \
                --work /runner-work \
                --unattended \
                --replace
              ./run.sh
          volumeMounts:
            - name: docker-sock
              mountPath: /var/run/docker.sock
            - name: runner-work
              mountPath: /runner-work
            - name: runner-token
              mountPath: /runner-token
          securityContext:
            privileged: true
      volumes:
        - name: docker-sock
          hostPath:
            path: /var/run/docker.sock
        - name: runner-work
          emptyDir: {}
        - name: runner-token
          emptyDir: {}
